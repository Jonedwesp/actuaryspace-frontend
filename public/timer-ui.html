<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WorkFlow Timer</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      padding: 16px; 
      margin: 0; 
      color: #172b4d; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
    }
    .btn { 
      border: none; 
      border-radius: 4px; 
      padding: 10px 12px; 
      font-weight: 600; 
      cursor: pointer; 
      font-size: 14px; 
      width: 100%; 
      transition: opacity 0.2s; 
    }
    .btn:hover { opacity: 0.9; }
    .btn-yellow { background-color: #f2d600; color: #172b4d; }
    .btn-red { background-color: #eb5a46; color: #fff; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .display { text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 4px; transition: color 0.3s; }
    .loading { font-size: 14px; color: #5e6c84; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>

  <div id="loader" class="loading">Connecting to ActuarySpace...</div>

  <div id="ui" style="display: none;">
    <div class="display" id="time-display">‚è± 0m</div>
    <button id="start-btn" class="btn btn-yellow" style="display: none;">Start WorkFlow</button>
    <button id="stop-btn" class="btn btn-red" style="display: none;">Stop WorkFlow</button>
  </div>

  <script>
    // 1. Initialize Trello Context
    const t = window.TrelloPowerUp.iframe();
    let cardId = null;
    let workDuration = 0;
    let workTimerStart = null;
    let liveInterval = null;

    const loader = document.getElementById('loader');
    const ui = document.getElementById('ui');
    const display = document.getElementById('time-display');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');

    // --- Time Formatting Helper ---
    function formatTime(totalMins) {
      const m = Math.floor(totalMins);
      if (m < 60) return `${m}m`;
      
      const hours = Math.floor(m / 60);
      const mins = m % 60;
      return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`; 
    }

    // 2. Fetch Initial Data
    async function init() {
      const card = await t.card('id');
      cardId = card.id;

      try {
        const res = await fetch('/.netlify/functions/trello');
        const data = await res.json();

        let foundCard = null;
        if (data.buckets) {
          for (const b of data.buckets) {
            const c = b.cards.find(x => x.id === cardId);
            if (c) { foundCard = c; break; }
          }
        }

        if (foundCard && foundCard.customFields) {
          const startKey = Object.keys(foundCard.customFields).find(k => k.includes("TimerStart")) || "WorkTimerStart";
          const durKey = Object.keys(foundCard.customFields).find(k => k.includes("Duration")) || "WorkDuration";

          let storedDur = parseFloat(foundCard.customFields[durKey] || "0");
          if (storedDur > 1000000) storedDur = 0; 
          workDuration = storedDur;

          let storedStart = parseFloat(foundCard.customFields[startKey] || "0");
          if (storedStart > 1000000000000) { 
            workTimerStart = storedStart;
          }

          // üõ°Ô∏è THE OFFLINE CATCH-UP SYSTEM üõ°Ô∏è
          const offlineStr = localStorage.getItem(`offline_stop_${cardId}`);
          if (offlineStr && workTimerStart) {
            // We found a saved stop time locally, but the database still thinks it's running!
            loader.style.display = 'block';
            loader.innerText = "Syncing offline time...";
            ui.style.display = 'none';
            
            const offlineData = JSON.parse(offlineStr);
            const sessionMins = Math.max(0, offlineData.stopTime - workTimerStart) / 1000 / 60;
            const recoveredTotal = (workDuration + sessionMins).toFixed(2);
            
            try {
               await setField('WorkDuration', recoveredTotal);
               await setField('WorkTimerStart', "");
               
               workDuration = parseFloat(recoveredTotal);
               workTimerStart = null;
               localStorage.removeItem(`offline_stop_${cardId}`); // Success! Clear the offline memory.
            } catch(syncErr) {
               console.warn("Still offline. Keeping local memory active.");
            }
          } else if (offlineStr && !workTimerStart) {
             // Edge case: Server already successfully stopped, clear obsolete local memory.
             localStorage.removeItem(`offline_stop_${cardId}`);
          }
        }
        render();
      } catch (err) {
        loader.innerText = "Network offline. Retrying...";
        console.error("Fetch error:", err);
      }
    }

    // 3. Update the Screen
    function render() {
      loader.style.display = 'none';
      ui.style.display = 'block';

      if (liveInterval) clearInterval(liveInterval);

      if (workTimerStart) {
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        updateLiveClock();
        liveInterval = setInterval(updateLiveClock, 1000);
      } else {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        display.innerText = `‚è± ${formatTime(workDuration)} logged`;
      }
      
      t.sizeTo('body');
    }

    // 4. Live Clock Math
    function updateLiveClock() {
      if (!workTimerStart) return;
      const diffMs = Math.max(0, Date.now() - workTimerStart);
      const liveMins = diffMs / 1000 / 60;
      const total = workDuration + liveMins;
      display.innerText = `‚è± ${formatTime(total)} (Recording)`;
    }

    // 5. Backend Write Helper
    async function setField(fieldName, valueText) {
      const res = await fetch('/.netlify/functions/trello-set-custom-field', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cardId, fieldName, valueText: String(valueText) })
      });
      if (!res.ok) throw new Error("Network failed");
      return res;
    }

    // 6. Button Clicks
    startBtn.onclick = async () => {
      setLoadingState(true);
      const now = Date.now();
      try {
        await setField('WorkTimerStart', now);
        workTimerStart = now;
        render();
      } catch (e) {
        alert('Network Offline: Could not start timer. Please check your connection.');
      }
      setLoadingState(false);
    }

    stopBtn.onclick = async () => {
      setLoadingState(true);
      const stopTime = Date.now();
      const sessionMins = (stopTime - workTimerStart) / 1000 / 60;
      const newTotal = (workDuration + sessionMins).toFixed(2);

      try {
        // Attempt normal save
        await setField('WorkDuration', newTotal);
        await setField('WorkTimerStart', "");
        
        workDuration = parseFloat(newTotal);
        workTimerStart = null;
        render();
      } catch (e) {
        // ‚ö†Ô∏è THE OFFLINE TRAP TRIGGER ‚ö†Ô∏è
        console.warn("Network failed, saving to local memory.");
        
        // 1. Save the exact stop time locally
        localStorage.setItem(`offline_stop_${cardId}`, JSON.stringify({ stopTime: stopTime }));
        
        // 2. Visually update the UI so the user isn't panicked
        workDuration = parseFloat(newTotal);
        workTimerStart = null;
        if (liveInterval) clearInterval(liveInterval);
        
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        
        display.innerText = `‚è± ${formatTime(workDuration)}`;
        
        // Give them a visual warning that it is waiting to sync
        display.style.color = "#eb5a46";
        setTimeout(() => { 
            display.innerText = `‚è± ${formatTime(workDuration)} (Saved Offline)`; 
        }, 100);
      }
      setLoadingState(false);
    }

    function setLoadingState(isLoading) {
      startBtn.disabled = isLoading;
      stopBtn.disabled = isLoading;
      startBtn.innerText = isLoading ? "Saving..." : "Start WorkFlow";
      stopBtn.innerText = isLoading ? "Saving..." : "Stop WorkFlow";
    }

    // Start!
    init();
  </script>
</body>
</html>